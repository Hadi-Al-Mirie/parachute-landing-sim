<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Parachute Landing Simulator v2</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Enhanced styles for new features */
        #altimeter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            z-index: 1000;
        }
        
        #altimeter .label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        #altimeter .value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        
        #health-bar {
            position: fixed;
            top: 20px;
            right: 350px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            min-width: 200px;
        }
        
        #health-bar .label {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .health-bar-container {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #555;
        }
        
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000 0%, #ffff00 50%, #00ff00 100%);
            transition: width 0.3s ease;
            width: 100%;
        }
        
        #health-value {
            text-align: center;
            font-weight: bold;
            margin-top: 5px;
        }
        
        #game-state {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 1000;
        }
        
        #controls-help {
            position: fixed;
            bottom: 20px;
            right: 350px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .key-hint {
            background: #333;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .death-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 48px;
            font-weight: bold;
            z-index: 2000;
        }
        
        .damage-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            font-size: 36px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Ground impact effect */
        .impact-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #8B4513;
            border-radius: 50%;
            pointer-events: none;
        }
        
        /* Landing sequence styles */
        .landing-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1500;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Three.js canvas will be inserted here -->
    </div>
    
    <!-- Altimeter -->
    <div id="altimeter">
        <div class="label">ALTITUDE</div>
        <div class="value" id="altitude-value">3000</div>
        <div class="label">METERS</div>
    </div>
    
    <!-- Health Bar -->
    <div id="health-bar">
        <div class="label">HEALTH STATUS</div>
        <div class="health-bar-container">
            <div class="health-bar-fill" id="health-bar-fill"></div>
        </div>
        <div id="health-value">100%</div>
    </div>
    
    <!-- Game State Display -->
    <div id="game-state">
        <div id="state-text">In Plane - Press <span class="key-hint">J</span> to Jump</div>
    </div>
    
    <!-- Controls Help -->
    <div id="controls-help">
        <div><span class="key-hint">J</span> - Jump from plane</div>
        <div><span class="key-hint">O</span> - Open parachute</div>
        <div><span class="key-hint">R</span> - Reset simulation</div>
        <div><span class="key-hint">Mouse</span> - Camera control</div>
    </div>
    
    <!-- Death Overlay -->
    <div id="death-overlay" class="death-overlay">
        <div>MISSION FAILED</div>
        <div style="font-size: 24px; margin-top: 20px;">Press R to restart</div>
    </div>
    
    <!-- Damage Indicator -->
    <div id="damage-indicator" class="damage-indicator"></div>
    
    <!-- Landing Warning -->
    <div id="landing-warning" class="landing-warning">
        PREPARE FOR LANDING!
    </div>
    
    <!-- Control Panel -->
    <div id="control-panel">
        <h3>Physics Controls</h3>
        
        <div class="control-group">
            <label for="gravity">Gravity (m/s²):</label>
            <input type="range" id="gravity" min="1" max="20" value="9.81" step="0.1">
            <span id="gravity-value">9.81</span>
        </div>
        
        <div class="control-group">
            <label for="mass">Mass (kg):</label>
            <input type="range" id="mass" min="50" max="150" value="80" step="1">
            <span id="mass-value">80</span>
        </div>
        
        <div class="control-group">
            <label for="drag-coefficient">Drag Coefficient:</label>
            <input type="range" id="drag-coefficient" min="0.1" max="2.0" value="1.3" step="0.1">
            <span id="drag-coefficient-value">1.3</span>
        </div>
        
        <div class="control-group">
            <label for="air-density">Air Density (kg/m³):</label>
            <input type="range" id="air-density" min="0.8" max="1.4" value="1.225" step="0.01">
            <span id="air-density-value">1.225</span>
        </div>
        
        <div class="control-group">
            <label for="parachute-area">Parachute Area (m²):</label>
            <input type="range" id="parachute-area" min="20" max="100" value="50" step="1">
            <span id="parachute-area-value">50</span>
        </div>
        
        <div class="control-group">
            <label for="wind-speed">Wind Speed (m/s):</label>
            <input type="range" id="wind-speed" min="0" max="20" value="0" step="0.5">
            <span id="wind-speed-value">0</span>
        </div>
        
        <div class="button-group">
            <button id="reset-simulation">Reset Simulation</button>
        </div>
        
        <!-- Physics Display -->
        <div id="physics-display">
            <h4>Real-time Physics</h4>
            <div class="physics-info">
                <div>Velocity: <span id="velocity-display">0.0</span> m/s</div>
                <div>Acceleration: <span id="acceleration-display">0.0</span> m/s²</div>
                <div>Drag Force: <span id="drag-force-display">0.0</span> N</div>
                <div>Gravity Force: <span id="gravity-force-display">0.0</span> N</div>
                <div>Terminal Velocity: <span id="terminal-velocity-display">0.0</span> m/s</div>
            </div>
        </div>
    </div>

    <!-- Import Three.js -->
    <script src="lib/three.min.js"></script>
    <script src="lib/OrbitControls.js"></script>
    
    <!-- Import our scripts -->
    <script src="physics/physics-engine.js"></script>
    <script src="3d-models/models.js"></script>
    <script>
        // Enhanced Parachute Simulator v2 with all requested improvements
        class EnhancedParachuteSimulatorV2 {
            constructor() {
                console.log('Initializing Enhanced Parachute Simulator v2...');
                
                // Game state
                this.gameState = {
                    inPlane: true,
                    hasJumped: false,
                    parachuteDeployed: false,
                    onGround: false,
                    isDead: false,
                    isLanding: false
                };
                
                // Health system
                this.health = 100;
                this.maxHealth = 100;
                
                try {
                    this.init();
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showError('Failed to initialize. Check console for details.');
                }
            }
            
            init() {
                // Initialize physics
                this.physics = new PhysicsEngine();
                console.log('Physics engine initialized');
                
                // Initialize scene
                this.initScene();
                console.log('Scene initialized');
                
                // Initialize controls
                this.initControls();
                console.log('Controls initialized');
                
                // Start animation loop
                this.clock = new THREE.Clock();
                this.animate();
                
                // Update displays
                this.updateGameStateDisplay();
                this.updateHealthDisplay();
                
                console.log('Enhanced Parachute Simulator v2 initialized successfully!');
            }
            
            initScene() {
                // Create scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 100, 2000);
                
                // Create camera - closer to action
                const aspect = window.innerWidth / window.innerHeight;
                this.camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 5000);
                this.camera.position.set(-120, 3010, 30); // Closer to plane
                
                // Create renderer with better compatibility
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: false,
                    powerPreference: "default", // Better compatibility
                    failIfMajorPerformanceCaveat: false
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Add fallback for older browsers
                if (!this.renderer.capabilities.isWebGL2) {
                    console.warn('WebGL2 not supported, using WebGL1');
                }
                
                document.getElementById('container').appendChild(this.renderer.domElement);
                
                // Create controls with enhanced settings for closer following
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.08; // Smoother movement
                this.controls.rotateSpeed = 0.25; // Slower rotation
                this.controls.zoomSpeed = 0.4; // Slower zoom
                this.controls.panSpeed = 0.4; // Slower pan
                this.controls.target.set(-100, 3000, 0); // Initially follow plane
                this.controls.minDistance = 5; // Allow closer zoom
                this.controls.maxDistance = 200; // Limit max distance
                
                // Create lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(100, 200, 100);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
                
                // Create models
                this.models = new Models();
                
                // Create and add objects
                this.parachutist = this.models.createParachutist();
                this.parachutist.position.set(-100, 3002, 0); // Inside plane
                this.parachutist.visible = false; // Hidden until jump
                this.scene.add(this.parachutist);
                
                this.parachute = this.models.createParachute();
                this.parachute.position.set(-100, 3010, 0);
                this.parachute.visible = false;
                this.scene.add(this.parachute);
                
                this.plane = this.models.createPlane();
                this.plane.position.set(-100, 3000, 0);
                this.plane.rotation.y = Math.PI / 2;
                this.scene.add(this.plane);
                
                // Enhanced ground - more visible and detailed
                const groundGeometry = new THREE.PlaneGeometry(3000, 3000, 150, 150);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x228B22, // Forest green
                    transparent: false
                });
                this.ground = new THREE.Mesh(groundGeometry, groundMaterial);
                
                // Add realistic height variation
                const vertices = groundGeometry.attributes.position.array;
                for (let i = 0; i < vertices.length; i += 3) {
                    vertices[i + 2] = Math.random() * 5 - 2; // Height variation
                }
                groundGeometry.attributes.position.needsUpdate = true;
                groundGeometry.computeVertexNormals();
                
                this.ground.rotation.x = -Math.PI / 2;
                this.ground.position.y = 0;
                this.ground.receiveShadow = true;
                this.scene.add(this.ground);
                
                this.clouds = this.models.createClouds();
                this.scene.add(this.clouds);
                
                // Window resize handler
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            initControls() {
                // Slider controls
                const sliders = [
                    { id: 'gravity', param: 'gravity', display: 'gravity-value' },
                    { id: 'mass', param: 'mass', display: 'mass-value' },
                    { id: 'drag-coefficient', param: 'dragCoefficient', display: 'drag-coefficient-value' },
                    { id: 'air-density', param: 'airDensity', display: 'air-density-value' },
                    { id: 'parachute-area', param: 'parachuteArea', display: 'parachute-area-value' },
                    { id: 'wind-speed', param: 'windSpeed', display: 'wind-speed-value' }
                ];
                
                sliders.forEach(config => {
                    const slider = document.getElementById(config.id);
                    const display = document.getElementById(config.display);
                    
                    if (slider && display) {
                        display.textContent = slider.value;
                        
                        slider.addEventListener('input', (e) => {
                            const value = parseFloat(e.target.value);
                            display.textContent = value.toFixed(2);
                            this.physics.updateParameter(config.param, value);
                        });
                    }
                });
                
                // Reset button
                const resetBtn = document.getElementById('reset-simulation');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => this.resetSimulation());
                }
                
                // Enhanced keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (this.gameState.isDead) {
                        if (e.code === 'KeyR') {
                            e.preventDefault();
                            this.resetSimulation();
                        }
                        return;
                    }
                    
                    switch(e.code) {
                        case 'KeyJ':
                            e.preventDefault();
                            this.jumpFromPlane();
                            break;
                        case 'KeyO':
                            e.preventDefault();
                            this.deployParachute();
                            break;
                        case 'KeyR':
                            e.preventDefault();
                            this.resetSimulation();
                            break;
                    }
                });
                
                // Start physics display updates
                this.startPhysicsDisplay();
            }
            
            jumpFromPlane() {
                if (this.gameState.inPlane && !this.gameState.hasJumped && !this.gameState.isDead) {
                    console.log('Player jumped from plane!');
                    
                    // Update game state
                    this.gameState.inPlane = false;
                    this.gameState.hasJumped = true;
                    
                    // Show parachutist
                    this.parachutist.visible = true;
                    
                    // Reset physics to start position
                    this.physics.reset();
                    this.physics.state.position.set(-100, 3000, 0);
                    
                    // Update display
                    this.updateGameStateDisplay();
                    
                    // Start plane flying away animation
                    this.animatePlaneExit();
                }
            }
            
            deployParachute() {
                if (this.gameState.hasJumped && !this.gameState.parachuteDeployed && 
                    !this.gameState.onGround && !this.gameState.isDead) {
                    
                    const currentHeight = this.physics.state.position.y;
                    
                    // Check if parachute deployment is too low (causes damage)
                    if (currentHeight < 50) {
                        const damage = this.calculateLowDeploymentDamage(currentHeight);
                        this.takeDamage(damage, `Low deployment! -${damage} HP`);
                    }
                    
                    if (this.physics.deployParachute()) {
                        this.models.deployParachute(this.parachute);
                        this.gameState.parachuteDeployed = true;
                        console.log('Parachute deployed at height:', currentHeight);
                        this.updateGameStateDisplay();
                    }
                }
            }
            
            calculateLowDeploymentDamage(height) {
                // Damage increases exponentially as height decreases below 50m
                if (height >= 50) return 0;
                const damageMultiplier = Math.pow((50 - height) / 50, 2);
                return Math.min(Math.floor(damageMultiplier * 60), 60);
            }
            
            calculateLandingDamage(velocity, height, hasParachute) {
                // Damage calculation based on impact velocity and conditions
                if (!hasParachute) {
                    // No parachute = death
                    return this.maxHealth;
                }
                
                // Base damage from velocity (terminal velocity with parachute ~5-6 m/s is safe)
                const safeVelocity = 6;
                const velocityDamage = Math.max(0, (velocity - safeVelocity) * 8);
                
                // Additional damage if landing from very low height with high speed
                const heightFactor = height < 10 ? 1.5 : 1.0;
                
                return Math.min(Math.floor(velocityDamage * heightFactor), this.maxHealth);
            }
            
            takeDamage(amount, message) {
                this.health = Math.max(0, this.health - amount);
                this.updateHealthDisplay();
                this.showDamageIndicator(message);
                
                if (this.health <= 0) {
                    this.gameState.isDead = true;
                    this.showDeathOverlay();
                }
            }
            
            showDamageIndicator(message) {
                const indicator = document.getElementById('damage-indicator');
                indicator.textContent = message;
                indicator.style.opacity = '1';
                
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 2000);
            }
            
            showDeathOverlay() {
                const overlay = document.getElementById('death-overlay');
                overlay.style.display = 'flex';
                this.updateGameStateDisplay();
            }
            
            hideDeathOverlay() {
                const overlay = document.getElementById('death-overlay');
                overlay.style.display = 'none';
            }
            
            resetSimulation() {
                // Reset game state
                this.gameState = {
                    inPlane: true,
                    hasJumped: false,
                    parachuteDeployed: false,
                    onGround: false,
                    isDead: false,
                    isLanding: false
                };
                
                // Reset health
                this.health = this.maxHealth;
                this.updateHealthDisplay();
                this.hideDeathOverlay();
                
                // Reset physics
                this.physics.reset();
                
                // Reset object positions
                this.parachutist.position.set(-100, 3002, 0);
                this.parachutist.visible = false;
                this.parachute.position.set(-100, 3010, 0);
                this.parachute.visible = false;
                this.plane.position.set(-100, 3000, 0);
                
                // Reset camera to follow plane (closer)
                this.camera.position.set(-120, 3010, 30);
                this.controls.target.set(-100, 3000, 0);
                
                this.updateGameStateDisplay();
                console.log('Simulation reset');
            }
            
            updateGameStateDisplay() {
                const stateText = document.getElementById('state-text');
                if (stateText) {
                    if (this.gameState.isDead) {
                        stateText.innerHTML = 'DEAD - Press <span class="key-hint">R</span> to Reset';
                    } else if (this.gameState.onGround) {
                        stateText.innerHTML = 'Landed! Press <span class="key-hint">R</span> to Reset';
                    } else if (this.gameState.isLanding) {
                        stateText.innerHTML = 'Landing Sequence - Prepare for Impact!';
                    } else if (this.gameState.parachuteDeployed) {
                        stateText.innerHTML = 'Parachute Open - Descending';
                    } else if (this.gameState.hasJumped) {
                        stateText.innerHTML = 'Free Fall - Press <span class="key-hint">O</span> to Open Parachute';
                    } else {
                        stateText.innerHTML = 'In Plane - Press <span class="key-hint">J</span> to Jump';
                    }
                }
            }
            
            updateHealthDisplay() {
                const healthFill = document.getElementById('health-bar-fill');
                const healthValue = document.getElementById('health-value');
                
                if (healthFill && healthValue) {
                    const healthPercent = (this.health / this.maxHealth) * 100;
                    healthFill.style.width = healthPercent + '%';
                    healthValue.textContent = Math.round(healthPercent) + '%';
                    
                    // Change color based on health
                    if (healthPercent > 70) {
                        healthFill.style.background = '#00ff00';
                    } else if (healthPercent > 30) {
                        healthFill.style.background = '#ffff00';
                    } else {
                        healthFill.style.background = '#ff0000';
                    }
                }
            }
            
            updateAltimeter() {
                const altitudeValue = document.getElementById('altitude-value');
                if (altitudeValue) {
                    let altitude;
                    if (this.gameState.hasJumped) {
                        altitude = Math.max(0, this.physics.state.position.y);
                    } else {
                        altitude = 3000; // Plane altitude
                    }
                    altitudeValue.textContent = Math.round(altitude);
                }
            }
            
            updateCameraFollowing() {
                if (this.gameState.inPlane) {
                    // Follow plane closely
                    const planePos = this.plane.position.clone();
                    const cameraOffset = new THREE.Vector3(-20, 10, 30); // Much closer
                    const desiredPos = planePos.clone().add(cameraOffset);
                    
                    this.camera.position.lerp(desiredPos, 0.05);
                    this.controls.target.lerp(planePos, 0.05);
                } else if (this.gameState.hasJumped && !this.gameState.onGround) {
                    // Follow player closely
                    const playerPos = this.physics.state.position.clone();
                    const cameraOffset = new THREE.Vector3(25, 25, 50); // Much closer
                    const desiredPos = playerPos.clone().add(cameraOffset);
                    
                    this.camera.position.lerp(desiredPos, 0.08);
                    this.controls.target.lerp(playerPos, 0.08);
                }
            }
            
            checkLandingSequence() {
                if (this.gameState.hasJumped && !this.gameState.onGround && !this.gameState.isDead) {
                    const currentHeight = this.physics.state.position.y;
                    
                    // Start landing sequence at 20 meters
                    if (currentHeight <= 20 && !this.gameState.isLanding) {
                        this.gameState.isLanding = true;
                        this.updateGameStateDisplay();
                        
                        // Show landing warning
                        const warning = document.getElementById('landing-warning');
                        warning.style.display = 'block';
                        setTimeout(() => {
                            warning.style.display = 'none';
                        }, 3000);
                        
                        console.log('Landing sequence initiated at height:', currentHeight);
                    }
                }
            }
            
            handleLanding() {
                const velocity = this.physics.state.velocity.length();
                const height = this.physics.state.position.y;
                
                // Close parachute automatically
                if (this.gameState.parachuteDeployed) {
                    this.parachute.visible = false;
                }
                
                // Calculate landing damage
                const damage = this.calculateLandingDamage(velocity, height, this.gameState.parachuteDeployed);
                
                if (damage > 0) {
                    if (damage >= this.maxHealth) {
                        this.takeDamage(damage, 'FATAL IMPACT!');
                    } else {
                        this.takeDamage(damage, `Hard landing! -${damage} HP`);
                    }
                }
                
                // Create ground impact effect
                this.createGroundImpactEffect(this.physics.state.position);
                
                // Add rolling animation (simple rotation)
                if (!this.gameState.isDead) {
                    this.animatePlayerRoll();
                }
                
                this.gameState.onGround = true;
                this.updateGameStateDisplay();
                console.log('Player landed with velocity:', velocity, 'damage:', damage);
            }
            
            animatePlayerRoll() {
                let rollAngle = 0;
                const rollAnimation = () => {
                    if (rollAngle < Math.PI * 4 && !this.gameState.isDead) { // 2 full rolls
                        rollAngle += 0.2;
                        this.parachutist.rotation.z = rollAngle;
                        requestAnimationFrame(rollAnimation);
                    } else {
                        this.parachutist.rotation.z = 0; // Reset rotation
                    }
                };
                rollAnimation();
            }
            
            animatePlaneExit() {
                const startPos = this.plane.position.clone();
                const targetPos = new THREE.Vector3(-500, 3000, 0);
                const duration = 8000; // 8 seconds
                const startTime = Date.now();
                
                const animatePlane = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    this.plane.position.lerpVectors(startPos, targetPos, progress);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animatePlane);
                    }
                };
                animatePlane();
            }
            
            createGroundImpactEffect(position) {
                // Create dust particles
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'impact-particle';
                    particle.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 150) + 'px';
                    particle.style.top = (window.innerHeight - 100 + (Math.random() - 0.5) * 80) + 'px';
                    document.body.appendChild(particle);
                    
                    // Animate particle
                    let opacity = 1;
                    let y = 0;
                    const animateParticle = () => {
                        y += 3;
                        opacity -= 0.015;
                        particle.style.transform = `translateY(-${y}px)`;
                        particle.style.opacity = opacity;
                        
                        if (opacity > 0) {
                            requestAnimationFrame(animateParticle);
                        } else {
                            document.body.removeChild(particle);
                        }
                    };
                    
                    setTimeout(() => animateParticle(), i * 30);
                }
                
                // Screen shake effect
                const originalTransform = document.body.style.transform;
                let shakeIntensity = 15;
                const shakeAnimation = () => {
                    if (shakeIntensity > 0) {
                        const x = (Math.random() - 0.5) * shakeIntensity;
                        const y = (Math.random() - 0.5) * shakeIntensity;
                        document.body.style.transform = `translate(${x}px, ${y}px)`;
                        shakeIntensity *= 0.85;
                        requestAnimationFrame(shakeAnimation);
                    } else {
                        document.body.style.transform = originalTransform;
                    }
                };
                shakeAnimation();
            }
            
            startPhysicsDisplay() {
                setInterval(() => {
                    const data = this.physics.getPhysicsData();
                    
                    const elements = {
                        'velocity-display': data.velocity.toFixed(1),
                        'acceleration-display': data.acceleration.toFixed(1),
                        'drag-force-display': data.dragForce.toFixed(1),
                        'gravity-force-display': data.gravityForce.toFixed(1),
                        'terminal-velocity-display': data.terminalVelocity.toFixed(1)
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                    
                    // Update altimeter
                    this.updateAltimeter();
                }, 100);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                const deltaTime = this.clock.getDelta();
                
                // Update physics only if player has jumped and is not dead
                if (this.gameState.hasJumped && !this.gameState.onGround && !this.gameState.isDead) {
                    this.physics.update(deltaTime);
                    const physicsData = this.physics.getPhysicsData();
                    
                    // Update object positions
                    this.parachutist.position.copy(physicsData.position);
                    
                    if (physicsData.parachuteDeployed && !this.gameState.isLanding) {
                        this.parachute.visible = true;
                        this.parachute.position.copy(physicsData.position);
                        this.parachute.position.y += 8;
                    }
                    
                    // Check for landing sequence
                    this.checkLandingSequence();
                    
                    // Check for ground collision
                    if (physicsData.position.y <= 0 && !this.gameState.onGround) {
                        this.handleLanding();
                    }
                }
                
                // Animate models
                if (this.models) {
                    this.models.animateParachutist(
                        this.parachutist, 
                        deltaTime, 
                        this.gameState.hasJumped ? this.physics.state.velocity : new THREE.Vector3()
                    );
                    
                    this.models.animatePlane(this.plane, deltaTime);
                    
                    if (this.gameState.parachuteDeployed && !this.gameState.isLanding) {
                        this.models.animateParachute(
                            this.parachute, 
                            deltaTime, 
                            this.physics.state.velocity
                        );
                    }
                }
                
                // Update camera following
                this.updateCameraFollowing();
                
                // Update controls and render
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #F44336;
                    color: white;
                    padding: 20px;
                    border-radius: 5px;
                    z-index: 5000;
                    font-weight: bold;
                `;
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
            }
        }
        
        // Initialize when ready with better browser compatibility
        function initSimulator() {
            try {
                new EnhancedParachuteSimulatorV2();
            } catch (error) {
                console.error('Failed to initialize simulator:', error);
                // Fallback for older browsers
                alert('Your browser may not support all features. Please use a modern browser like Chrome, Firefox, or Edge.');
            }
        }
        
        // Multiple initialization methods for better compatibility
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSimulator);
        } else {
            initSimulator();
        }
        
        // Fallback initialization
        window.addEventListener('load', () => {
            if (!window.simulatorInitialized) {
                initSimulator();
                window.simulatorInitialized = true;
            }
        });
    </script>
</body>
</html>

