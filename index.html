<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parachute Landing Simulator</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="container">
      <!-- Three.js canvas will be inserted here -->
    </div>

    <!-- Control Panel -->
    <div id="control-panel">
      <h3>Physics Controls</h3>

      <div class="control-group">
        <label for="gravity">Gravity (m/s²):</label>
        <input
          type="range"
          id="gravity"
          min="1"
          max="20"
          value="9.81"
          step="0.1"
        />
        <span id="gravity-value">9.81</span>
      </div>

      <div class="control-group">
        <label for="mass">Mass (kg):</label>
        <input type="range" id="mass" min="50" max="150" value="80" step="1" />
        <span id="mass-value">80</span>
      </div>

      <div class="control-group">
        <label for="drag-coefficient">Drag Coefficient:</label>
        <input
          type="range"
          id="drag-coefficient"
          min="0.1"
          max="2.0"
          value="1.3"
          step="0.1"
        />
        <span id="drag-coefficient-value">1.3</span>
      </div>

      <div class="control-group">
        <label for="air-density">Air Density (kg/m³):</label>
        <input
          type="range"
          id="air-density"
          min="0.8"
          max="1.4"
          value="1.225"
          step="0.01"
        />
        <span id="air-density-value">1.225</span>
      </div>

      <div class="control-group">
        <label for="parachute-area">Parachute Area (m²):</label>
        <input
          type="range"
          id="parachute-area"
          min="20"
          max="100"
          value="50"
          step="1"
        />
        <span id="parachute-area-value">50</span>
      </div>

      <div class="control-group">
        <label for="wind-speed">Wind Speed (m/s):</label>
        <input
          type="range"
          id="wind-speed"
          min="0"
          max="20"
          value="0"
          step="0.5"
        />
        <span id="wind-speed-value">0</span>
      </div>

      <div class="button-group">
        <button id="deploy-parachute">Deploy Parachute</button>
        <button id="reset-simulation">Reset</button>
        <button id="start-simulation">Start Jump</button>
      </div>

      <!-- Physics Display -->
      <div id="physics-display">
        <h4>Real-time Physics</h4>
        <div class="physics-info">
          <div>
            Plane Position:
            <span id="plane-position-display">0.0, 0.0, 0.0</span>
          </div>
          <div>
            Player Position:
            <span id="player-position-display">0.0, 0.0, 0.0</span>
          </div>
          <!-- Health display -->
          <div id="health-container">
            <div class="health-text">
              <span>Health:</span>
              <span id="health-value">100</span>
            </div>
            <div id="health-bar-wrapper">
              <div id="health-bar"></div>
            </div>
          </div>
          <div>Velocity: <span id="velocity-display">0.0</span> m/s</div>
          <div>Altitude: <span id="altitude-display">3000</span> m</div>
          <div>
            Acceleration: <span id="acceleration-display">0.0</span> m/s²
          </div>
          <div>Drag Force: <span id="drag-force-display">0.0</span> N</div>
          <div>
            Terminal Velocity:
            <span id="terminal-velocity-display">0.0</span> m/s
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div id="instructions">
      <h3>Instructions</h3>
      <p>1. Adjust physics parameters using the controls</p>
      <p>2. Click "Start Jump" to begin simulation</p>
      <p>3. Click "Deploy Parachute" when ready</p>
      <p>4. Use "Reset" to restart the simulation</p>
      <button id="close-instructions">Got it!</button>
    </div>

    <!-- Import Three.js -->
    <script src="lib/three.min.js"></script>
    <script src="lib/OrbitControls.js"></script>

    <!-- Import our scripts -->
    <script src="physics/physics-engine.js"></script>
    <script src="3d-models/models.js"></script>
    <!-- ← UPDATE THIS LINE: use unpkg to get the correct MIME type -->
    <script src="lib/OBJLoader.js"></script>

    <script>
      // Main application - simplified and working
      class ParachuteSimulator {
        constructor() {
          console.log("Initializing Parachute Simulator...");

          try {
            this.init();
          } catch (error) {
            console.error("Initialization failed:", error);
            this.showError("Failed to initialize. Check console for details.");
          }
        }

        init() {
          // Initialize physics
          this.physics = new PhysicsEngine();
          console.log("Physics engine initialized");

          this.planeSpeed = 10;
          // Initialize scene
          this.initScene();
          console.log("Scene initialized");

          // Initialize controls
          this.initControls();
          console.log("Controls initialized");

          // Start animation loop
          this.clock = new THREE.Clock();
          this.animate();
          // Initialize player health and foot offset.
          this.maxHealth = 100;
          this.health = this.maxHealth;
          // approximate distance from model origin to feet; ensures feet touch the ground at y = 0
          this.footOffset = 0.8;
          // track whether the player has landed
          this.hasLanded = false;

          // Health bar elements
          this.healthBar = document.getElementById("health-bar");
          this.healthValueEl = document.getElementById("health-value");
          this.updateHealthBar();

          // Register ground hit event
          this.physics.onGroundHit((impactSpeed) => {
            this.onGroundImpact(impactSpeed);
          });

          // Hide instructions after delay
          setTimeout(() => {
            const instructions = document.getElementById("instructions");
            if (instructions) {
              instructions.classList.add("hidden");
            }
          }, 5000);

          console.log("Parachute Simulator initialized successfully!");
        }

        initScene() {
          // Create scene
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0x87ceeb);
          this.scene.fog = new THREE.Fog(0x87ceeb, 100, 2000);

          // Create camera
          const aspect = window.innerWidth / window.innerHeight;
          this.camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 5000);
          this.camera.position.set(50, 3050, 100);

          // Create renderer
          this.renderer = new THREE.WebGLRenderer({ antialias: true });
          this.renderer.setSize(window.innerWidth, window.innerHeight);
          this.renderer.shadowMap.enabled = true;
          this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
          document
            .getElementById("container")
            .appendChild(this.renderer.domElement);

          // Create controls
          this.controls = new THREE.OrbitControls(
            this.camera,
            this.renderer.domElement,
          );
          this.controls.enableDamping = true;
          this.controls.dampingFactor = 0.05;
          this.controls.target.set(0, 3000, 0);

          // Create lighting
          const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
          this.scene.add(ambientLight);

          const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
          directionalLight.position.set(100, 200, 100);
          directionalLight.castShadow = true;
          this.scene.add(directionalLight);

          // Create models
          this.models = new Models();

          // Create and add objects
          this.parachutist = this.models.createParachutist();
          this.parachutist.position.set(0, 3000, 0);
          this.scene.add(this.parachutist);

          this.parachute = this.models.createParachute();
          this.parachute.position.set(0, 3008, 0);
          this.scene.add(this.parachute);

          this.plane = this.models.createPlane();
          this.plane.position.set(-100, 3000, 0);
          this.plane.rotation.y = Math.PI / 2;
          this.scene.add(this.plane);

          this.ground = this.models.createGround();
          this.scene.add(this.ground);

          this.clouds = this.models.createClouds();
          this.scene.add(this.clouds);

          // Window resize handler
          window.addEventListener("resize", () => {
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
          });
        }

        initControls() {
          // Slider controls
          const sliders = [
            { id: "gravity", param: "gravity", display: "gravity-value" },
            { id: "mass", param: "mass", display: "mass-value" },
            {
              id: "drag-coefficient",
              param: "dragCoefficient",
              display: "drag-coefficient-value",
            },
            {
              id: "air-density",
              param: "airDensity",
              display: "air-density-value",
            },
            {
              id: "parachute-area",
              param: "parachuteArea",
              display: "parachute-area-value",
            },
            {
              id: "wind-speed",
              param: "windSpeed",
              display: "wind-speed-value",
            },
          ];

          sliders.forEach((config) => {
            const slider = document.getElementById(config.id);
            const display = document.getElementById(config.display);

            if (slider && display) {
              display.textContent = slider.value;

              slider.addEventListener("input", (e) => {
                const value = parseFloat(e.target.value);
                display.textContent = value.toFixed(2);
                this.physics.updateParameter(config.param, value);
              });
            }
          });

          // Button controls
          const startBtn = document.getElementById("start-simulation");
          if (startBtn) {
            startBtn.addEventListener("click", () => this.startSimulation());
          }

          const deployBtn = document.getElementById("deploy-parachute");
          if (deployBtn) {
            deployBtn.addEventListener("click", () => this.deployParachute());
          }

          const resetBtn = document.getElementById("reset-simulation");
          if (resetBtn) {
            resetBtn.addEventListener("click", () => this.resetSimulation());
          }

          // Instructions close button
          const closeInstructionsBtn =
            document.getElementById("close-instructions");
          if (closeInstructionsBtn) {
            closeInstructionsBtn.addEventListener("click", () => {
              document.getElementById("instructions").classList.add("hidden");
            });
          }

          // Keyboard controls
          document.addEventListener("keydown", (e) => {
            switch (e.code) {
              case "Space":
                e.preventDefault();
                this.deployParachute();
                break;
              case "KeyR":
                e.preventDefault();
                this.resetSimulation();
                break;
              case "KeyS":
                e.preventDefault();
                this.startSimulation();
                break;
            }
          });

          // Start physics display updates
          this.startPhysicsDisplay();
        }

        // Inside your ParachuteSimulator class, replace or add this method:

        // Replace your existing startSimulation() in ParachuteSimulator with this:

        startSimulation() {
          // Prevent double-start
          if (this.isSimulationRunning) return;

          // 1. Grab the plane's current world-space position
          const planePos = this.plane.position.clone();
          console.log(
            `Cloning current plane position : (${planePos.x.toFixed(1)}, ` +
              `${planePos.y.toFixed(1)}, ${planePos.z.toFixed(1)})`,
          );
          // 2. Initialize the physics engine state to that spot
          this.physics.state.position.copy(planePos);
          this.physics.state.velocity.set(0, 0, 0);
          this.physics.state.acceleration.set(0, 0, 0);
          this.physics.state.time = 0;

          // 3. Make sure the visual parachute is hidden until deployed
          this.parachute.visible = false;

          // 4. Flip on physics mode
          this.isSimulationRunning = true;

          console.log(
            `Jump started! Snapped to plane at (${planePos.x.toFixed(1)}, ` +
              `${planePos.y.toFixed(1)}, ${planePos.z.toFixed(1)})`,
          );
        }

        deployParachute() {
          if (this.physics.deployParachute()) {
            this.models.deployParachute(this.parachute);
            console.log("Parachute deployed");

            const deployBtn = document.getElementById("deploy-parachute");
            if (deployBtn) {
              deployBtn.disabled = true;
              deployBtn.textContent = "Parachute Deployed";
              deployBtn.style.background = "#4CAF50";
            }
          }
        }

        resetSimulation() {
          // Reset the underlying physics engine state
          this.physics.reset();
          // Stop the simulation loop
          this.isSimulationRunning = false;

          // Clear the landed flag so the jumper reattaches to the plane on the next frame
          this.hasLanded = false;

          // Restore player health to maximum and update the health bar
          this.health = this.maxHealth;
          this.updateHealthBar();

          // Reset the parachutist orientation and landing animation state
          if (this.parachutist) {
            this.parachutist.rotation.set(0, 0, 0);
            if (this.parachutist.userData) {
              this.parachutist.userData.landingAnimation = false;
            }
          }

          // Reset parachute state (hide it and mark as not deployed)
          if (this.parachute) {
            this.parachute.visible = false;
            // Ensure parachute deployment animation can run again
            if (this.parachute.userData) {
              this.parachute.userData.deployed = false;
            }
            // Restore parachute scale in case it was modified during deployment
            this.parachute.scale.set(1, 1, 1);
          }

          // Reset positions of all major objects
          // Place the parachutist and parachute at their default altitudes;
          // the animate loop will subsequently glue them to the plane when hasLanded is false
          this.parachutist.position.set(0, 3000, 0);
          this.parachute.position.set(0, 3008, 0);
          this.plane.position.set(-100, 3000, 0);

          // Reset camera and OrbitControls target to initial values
          this.camera.position.set(50, 3050, 100);
          this.controls.target.set(0, 3000, 0);

          // Re-enable the deploy button and restore its label and styling
          const deployBtn = document.getElementById("deploy-parachute");
          if (deployBtn) {
            deployBtn.disabled = false;
            deployBtn.textContent = "Deploy Parachute";
            deployBtn.style.background = "#ff6b6b";
          }

          console.log("Simulation reset after updates ");
        }

        startPhysicsDisplay() {
          setInterval(() => {
            // 1. physics stats
            const data = this.physics.getPhysicsData();
            const stats = {
              "velocity-display": data.velocity.toFixed(1),
              // altitude is the physical foot position plus footOffset
              "altitude-display": (data.altitude + this.footOffset).toFixed(0),
              "acceleration-display": data.acceleration.toFixed(1),
              "drag-force-display": data.dragForce.toFixed(1),
              "terminal-velocity-display": data.terminalVelocity.toFixed(1),
            };
            Object.entries(stats).forEach(([id, val]) => {
              const el = document.getElementById(id);
              if (el) el.textContent = val;
            });

            // 2. plane position
            const p = this.plane.position;
            const planePos = `${p.x.toFixed(1)}, ${p.y.toFixed(
              1,
            )}, ${p.z.toFixed(1)}`;
            const planeEl = document.getElementById("plane-position-display");
            if (planeEl) planeEl.textContent = planePos;

            // 3. player position
            const q = this.parachutist.position;
            const playerPos = `${q.x.toFixed(1)}, ${q.y.toFixed(
              1,
            )}, ${q.z.toFixed(1)}`;
            const playerEl = document.getElementById("player-position-display");
            if (playerEl) playerEl.textContent = playerPos;
          }, 100);
        }

        animate() {
          // schedule next frame
          requestAnimationFrame(() => this.animate());

          // Δt in seconds
          const deltaTime = this.clock.getDelta();

          // ——— Always move the plane forward along +X ———
          this.plane.position.z += this.planeSpeed * deltaTime;

          let physicsData = null;

          if (this.isSimulationRunning) {
            // physics-driven fall
            this.physics.update(deltaTime);
            physicsData = this.physics.getPhysicsData();

            // move jumper by physics; apply foot offset
            this.parachutist.position.copy(physicsData.position);
            this.parachutist.position.y += this.footOffset;

            // move parachute if deployed
            if (physicsData.parachuteDeployed) {
              this.parachute.visible = true;
              this.parachute.position.copy(physicsData.position);
              this.parachute.position.y += this.footOffset + 8;
            }
            // camera follows the jumper
            const followPos = physicsData.position.clone();
            const cameraOffset = new THREE.Vector3(5, 20, 100);
            this.camera.position.lerp(
              followPos.clone().add(cameraOffset),
              0.02,
            );
            this.controls.target.lerp(followPos, 0.02);
          } else {
            // before jump or after landing
            if (!this.hasLanded) {
              // attach to the plane
              const planePos = this.plane.position;
              const renderPos = planePos.clone();
              renderPos.y += this.footOffset;
              this.parachutist.position.copy(renderPos);
              this.parachute.position.copy(renderPos).y += 8;

              // camera follows plane
              const followPos = planePos.clone();
              const cameraOffset = new THREE.Vector3(20, 20, 40);
              this.camera.position.lerp(
                followPos.clone().add(cameraOffset),
                0.02,
              );
              this.controls.target.lerp(followPos, 0.02);
            } else {
              // after landing, keep model still and slowly orbit camera
              const landedPos = this.parachutist.position.clone();
              const cameraOffset = new THREE.Vector3(10, 15, 30);
              this.camera.position.lerp(
                landedPos.clone().add(cameraOffset),
                0.02,
              );
              this.controls.target.lerp(landedPos, 0.02);
            }
          }

          // ——— Animate models (limbs, propeller, sway, etc.) ———
          if (this.models) {
            const vel = physicsData
              ? this.physics.state.velocity
              : new THREE.Vector3(0, 0, 0);

            this.models.animateParachutist(this.parachutist, deltaTime, vel);
            this.models.animatePlane(this.plane, deltaTime);
            this.models.animateParachute(this.parachute, deltaTime, vel);
          }

          // final render
          this.controls.update();
          this.renderer.render(this.scene, this.camera);
        }
        // Update the visual health bar
        updateHealthBar() {
          const pct = Math.max(0, this.health) / this.maxHealth;
          if (this.healthBar) {
            this.healthBar.style.width = `${pct * 100}%`;
            let color;
            if (pct > 0.6) {
              color = "#4ecdc4"; // green
            } else if (pct > 0.3) {
              color = "#ffb74d"; // orange
            } else {
              color = "#f44336"; // red
            }
            this.healthBar.style.background = color;
          }
          if (this.healthValueEl) {
            this.healthValueEl.textContent = Math.round(this.health);
          }
        }

        // Called whenever the physics engine reports a ground hit
        onGroundImpact(impactSpeed) {
          // mark as landed
          this.hasLanded = true;

          // calculate damage
          let damage = 0;
          const parachuteDeployed = this.physics.parameters.parachuteDeployed;
          if (!parachuteDeployed || impactSpeed >= 15) {
            damage = this.maxHealth; // fatal without parachute or very high speed
          } else {
            if (impactSpeed < 5) {
              damage = 0;
            } else if (impactSpeed < 10) {
              damage = (impactSpeed - 5) * 5;
            } else if (impactSpeed < 15) {
              damage = 25 + (impactSpeed - 10) * 10;
            } else {
              damage = this.maxHealth;
            }
          }

          // apply damage and update bar
          this.health = Math.max(0, this.health - damage);
          this.updateHealthBar();

          // stop simulation after landing so the player no longer falls with the plane
          this.isSimulationRunning = false;

          // choose animation based on damage
          if (this.health <= 0) {
            this.models.animateDeath(this.parachutist);
          } else if (damage > 50) {
            this.models.animateHardLanding(this.parachutist);
          } else if (damage > 0) {
            this.models.animateModerateLanding(this.parachutist);
          } else {
            if (parachuteDeployed) {
              this.models.animateSoftLanding(this.parachutist);
            }
          }
        }

        showError(message) {
          const errorDiv = document.createElement("div");
          errorDiv.style.cssText = `
                          position: fixed;
                          top: 50%;
                          left: 50%;
                          transform: translate(-50%, -50%);
                          background: #F44336;
                          color: white;
                          padding: 20px;
                          border-radius: 5px;
                          z-index: 5000;
                          font-weight: bold;
                      `;
          errorDiv.textContent = message;
          document.body.appendChild(errorDiv);
        }
      }

      // Initialize when ready
      document.addEventListener("DOMContentLoaded", () => {
        new ParachuteSimulator();
      });
    </script>
  </body>
</html>
